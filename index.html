<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // KONFIGURASI SUPABASE (Ganti dengan milik Anda)
    const SUPABASE_URL = 'https://YOUR_PROJECT_ID.supabase.co';
    const SUPABASE_KEY = 'YOUR_ANON_KEY';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allPrompts = []; // Penampung data dari database

    const gallery = document.getElementById('gallery');
    const search = document.getElementById('search');
    const filter = document.getElementById('filter');
    const detail = document.getElementById('detail');

    // Ambil Data dari Supabase
    async function fetchPrompts() {
        gallery.innerHTML = '<div class="col-span-full text-center py-10 text-slate-500 animate-pulse">Memuat database prompt...</div>';
        
        const { data, error } = await supabase
            .from('prompts')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error:', error);
            gallery.innerHTML = '<div class="col-span-full text-center text-red-400">Gagal memuat data. Periksa koneksi/API Key.</div>';
            return;
        }

        allPrompts = data;
        render(allPrompts);
    }

    function render(dataToRender) {
        gallery.innerHTML = '';
        const q = search.value.toLowerCase();
        const f = filter.value;
        
        const filtered = dataToRender.filter(p => 
            (!f || p.cat === f) && 
            (p.title.toLowerCase().includes(q) || p.description.toLowerCase().includes(q))
        );

        if (filtered.length === 0) {
            gallery.innerHTML = '<div class="col-span-full text-center py-10 text-slate-500">Prompt tidak ditemukan.</div>';
            return;
        }

        filtered.forEach(p => {
            const card = document.createElement('div');
            card.className = 'prompt-card rounded-3xl p-6 flex flex-col justify-between';
            card.innerHTML = `
                <div>
                    <span class="text-[10px] font-bold text-sky-400 bg-sky-500/10 px-3 py-1 rounded-full uppercase border border-sky-500/20">${p.cat}</span>
                    <h3 class="text-xl font-bold mt-4 mb-2">${p.title}</h3>
                    <p class="text-slate-400 text-sm leading-relaxed mb-6">${p.description}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="openDetail('${p.id}')" class="flex-grow bg-slate-800 hover:bg-slate-700 text-sm font-semibold py-2.5 rounded-xl transition">Detail</button>
                    <button onclick="quickCopy(event, \`${p.body.replace(/`/g, "\\`")}\`)" class="px-4 py-2.5 bg-sky-500/10 hover:bg-sky-500 text-sky-400 rounded-xl transition">
                        ðŸ“‹
                    </button>
                </div>
            `;
            gallery.appendChild(card);
        });
    }

    function openDetail(id) {
        const p = allPrompts.find(x => x.id === id);
        document.getElementById('d-title').textContent = p.title;
        document.getElementById('d-cat').textContent = p.cat;
        document.getElementById('d-desc').textContent = p.description;
        document.getElementById('d-text').value = p.body;
        detail.showModal();
    }

    function quickCopy(e, text) {
        navigator.clipboard.writeText(text);
        const btn = e.currentTarget;
        const original = btn.innerHTML;
        btn.innerHTML = 'âœ…';
        btn.classList.add('bg-sky-500', 'text-slate-900');
        setTimeout(() => {
            btn.innerHTML = original;
            btn.classList.remove('bg-sky-500', 'text-slate-900');
        }, 2000);
    }

    function copyFromModal() {
        const txt = document.getElementById('d-text');
        navigator.clipboard.writeText(txt.value);
        const btn = document.getElementById('copyBtn');
        const original = btn.innerText;
        btn.innerText = 'âœ… Tersalin!';
        btn.style.background = '#22c55e';
        setTimeout(() => {
            btn.innerText = original;
            btn.style.background = '';
        }, 2000);
    }

    // Listener Real-time (Otomatis Update tanpa Refresh jika data di Supabase berubah)
    const mySubscription = supabase
        .channel('public:prompts')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'prompts' }, payload => {
            fetchPrompts(); // Refresh data jika ada perubahan di DB
        })
        .subscribe();

    search.oninput = () => render(allPrompts);
    filter.onchange = () => render(allPrompts);
    
    // Inisialisasi Ambil Data
    fetchPrompts();
</script>
